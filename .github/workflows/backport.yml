name: Backport to develop

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  backport:
    runs-on: ubuntu-latest
    # Solo si el PR fue mergeado
    if: github.event.pull_request.merged == true

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Config git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Crear branch de backport y cherry-pick
        env:
          TARGET_BRANCH: develop
          PR_NUMBER: ${{ github.event.pull_request.number }}
          MERGE_SHA: ${{ github.event.pull_request.merge_commit_sha }}
        run: |
          set -e  # Exit on error
          BACKPORT_BRANCH=backport/pr-${PR_NUMBER}-to-${TARGET_BRANCH}

          # Traer develop
          git fetch origin ${TARGET_BRANCH}
          git checkout -b ${BACKPORT_BRANCH} origin/${TARGET_BRANCH}

          # Cherry-pick del merge de main
          HAS_CONFLICTS=false
          CONFLICT_FILES=""
          
          if ! git cherry-pick -m 1 -x ${MERGE_SHA}; then
            echo "Cherry-pick failed, attempting to auto-resolve conflicts"
            
            # List all conflicted files for debugging
            echo "=== Conflicted files ==="
            git status --porcelain | grep "^UU" || echo "No UU conflicts detected"
            echo "========================"
            
            # Function to auto-resolve a file
            auto_resolve() {
              local file="$1"
              echo "Auto-resolving: $file"
              
              # Extract the version from main (being cherry-picked)
              if git show :3:"$file" > "$file" 2>/dev/null; then
                git add "$file"
                echo "âœ“ Successfully resolved: $file"
                return 0
              else
                echo "âœ— Failed to extract :3 version for: $file"
                return 1
              fi
            }
            
            # Auto-resolve known conflict files
            FILES_TO_RESOLVE=(
              "CHANGELOG.md"
              "package.json"
              ".github/workflows/backport.yml"
            )
            
            for file in "${FILES_TO_RESOLVE[@]}"; do
              if git status --porcelain | grep -q "^UU $file"; then
                auto_resolve "$file" || true
              fi
            done
            
            # Check for remaining unresolved conflicts
            echo "=== Checking for remaining conflicts ==="
            REMAINING_CONFLICTS=$(git diff --name-only --diff-filter=U)
            
            if [ -n "$REMAINING_CONFLICTS" ]; then
              echo "âš ï¸  Unresolved conflicts remain in:"
              echo "$REMAINING_CONFLICTS"
              HAS_CONFLICTS=true
              CONFLICT_FILES="$REMAINING_CONFLICTS"
              
              # Add all files (including those with conflict markers) and commit
              echo "Creating commit with conflict markers for manual resolution..."
              git add -A
              git -c core.editor=true cherry-pick --continue || {
                # If continue fails, commit manually
                git commit -m "Cherry-pick $MERGE_SHA with conflicts" \
                           -m "" \
                           -m "âš ï¸  This commit contains unresolved conflicts in:" \
                           -m "$REMAINING_CONFLICTS" \
                           -m "" \
                           -m "Please resolve these conflicts manually." \
                           --no-edit
              }
            else
              echo "âœ“ All conflicts auto-resolved successfully"
              # Continue cherry-pick with auto-resolved conflicts
              git -c core.editor=true cherry-pick --continue
            fi
          fi

          echo "âœ“ Cherry-pick completed"
          git push origin ${BACKPORT_BRANCH}
          
          # Export conflict info for PR creation
          echo "HAS_CONFLICTS=$HAS_CONFLICTS" >> $GITHUB_ENV
          echo "CONFLICT_FILES<<EOF" >> $GITHUB_ENV
          echo "$CONFLICT_FILES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Crear PR hacia develop
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          MERGE_SHA: ${{ github.event.pull_request.merge_commit_sha }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          BACKPORT_BRANCH=backport/pr-${PR_NUMBER}-to-develop
          
          # Build PR body based on conflict status
          if [ "$HAS_CONFLICTS" = "true" ]; then
            {
              echo "ðŸ”„ Backport automÃ¡tico de #${PR_NUMBER} a \`develop\`."
              echo ""
              echo "**âš ï¸ CONFLICTOS DETECTADOS**"
              echo ""
              echo "Los siguientes archivos tienen conflictos que necesitan resoluciÃ³n manual:"
              echo '```'
              echo "${CONFLICT_FILES}"
              echo '```'
              echo ""
              echo "Por favor, revisa y resuelve los conflictos antes de mergear este PR."
              echo ""
              echo "---"
              echo ""
              echo "**PR original:** #${PR_NUMBER}"
              echo "**TÃ­tulo:** ${PR_TITLE}"
              echo "**Commit:** ${MERGE_SHA}"
              echo ""
              echo "_Este PR fue creado automÃ¡ticamente por el workflow de backport._"
            } > pr_body.txt
          else
            {
              echo "ðŸ”„ Backport automÃ¡tico de #${PR_NUMBER} a \`develop\`."
              echo ""
              echo "âœ… Todos los conflictos fueron resueltos automÃ¡ticamente."
              echo ""
              echo "**PR original:** #${PR_NUMBER}"
              echo "**TÃ­tulo:** ${PR_TITLE}"
              echo "**Commit:** ${MERGE_SHA}"
              echo ""
              echo "---"
              echo "_Este PR fue creado automÃ¡ticamente por el workflow de backport._"
            } > pr_body.txt
          fi
          
          # Create PR, with or without label depending on if it exists
          if gh label list | grep -q "^backport"; then
            gh pr create \
              --base develop \
              --head ${BACKPORT_BRANCH} \
              --title "Backport #${PR_NUMBER} to develop" \
              --body-file pr_body.txt \
              --label backport
          else
            echo "Warning: 'backport' label not found, creating PR without label"
            gh pr create \
              --base develop \
              --head ${BACKPORT_BRANCH} \
              --title "Backport #${PR_NUMBER} to develop" \
              --body-file pr_body.txt
          fi
