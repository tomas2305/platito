name: Backport to develop

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  backport:
    runs-on: ubuntu-latest
    # Solo si el PR fue mergeado
    if: github.event.pull_request.merged == true

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Config git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Crear branch de backport y cherry-pick
        env:
          TARGET_BRANCH: develop
          PR_NUMBER: ${{ github.event.pull_request.number }}
          MERGE_SHA: ${{ github.event.pull_request.merge_commit_sha }}
        run: |
          BACKPORT_BRANCH=backport/pr-${PR_NUMBER}-to-${TARGET_BRANCH}

          # Traer develop
          git fetch origin ${TARGET_BRANCH}
          git checkout -b ${BACKPORT_BRANCH} origin/${TARGET_BRANCH}

          # Cherry-pick del merge de main
          if ! git cherry-pick -m 1 -x ${MERGE_SHA}; then
            echo "Cherry-pick failed, attempting to auto-resolve conflicts"
            
            # Check if CHANGELOG.md has conflicts
            if git status | grep -q "CHANGELOG.md"; then
              echo "CHANGELOG.md has conflicts, auto-resolving..."
              
              # Accept both changes for CHANGELOG (ours + theirs)
              git show HEAD:CHANGELOG.md > /tmp/changelog_ours.md || true
              git show ${MERGE_SHA}:CHANGELOG.md > /tmp/changelog_theirs.md || true
              
              # Merge CHANGELOG sections manually (keep unreleased from theirs, rest from ours)
              # For now, accept theirs (incoming changes from main)
              git checkout --theirs CHANGELOG.md
              git add CHANGELOG.md
            fi
            
            # Check if there are still conflicts
            if git diff --name-only --diff-filter=U | grep -q .; then
              echo "Unable to auto-resolve all conflicts"
              git cherry-pick --abort
              exit 1
            fi
            
            # Continue cherry-pick
            git cherry-pick --continue --no-edit
          fi

          git push origin ${BACKPORT_BRANCH}

      - name: Crear PR hacia develop
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: develop
          branch: backport/pr-${{ github.event.pull_request.number }}-to-develop
          title: "Backport #${{ github.event.pull_request.number }} to develop"
          body: |
            ðŸ”„ Backport automÃ¡tico de #${{ github.event.pull_request.number }} a `develop`.
            
            **PR original:** #${{ github.event.pull_request.number }}
            **Commit:** ${{ github.event.pull_request.merge_commit_sha }}
            
            ---
            _Este PR fue creado automÃ¡ticamente por el workflow de backport._
          labels: backport
          delete-branch: true
