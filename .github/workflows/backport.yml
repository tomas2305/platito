name: Backport to develop

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  backport:
    runs-on: ubuntu-latest
    # Solo si el PR fue mergeado
    if: github.event.pull_request.merged == true

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Config git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Crear branch de backport y cherry-pick
        env:
          TARGET_BRANCH: develop
          PR_NUMBER: ${{ github.event.pull_request.number }}
          MERGE_SHA: ${{ github.event.pull_request.merge_commit_sha }}
        run: |
          BACKPORT_BRANCH=backport/pr-${PR_NUMBER}-to-${TARGET_BRANCH}

          # Traer develop
          git fetch origin ${TARGET_BRANCH}
          git checkout -b ${BACKPORT_BRANCH} origin/${TARGET_BRANCH}

          # Cherry-pick del merge de main
          if ! git cherry-pick -m 1 -x ${MERGE_SHA}; then
            echo "Cherry-pick failed, attempting to auto-resolve conflicts"
            
            # Auto-resolve CHANGELOG.md conflicts (accept incoming from main)
            if git status --porcelain | grep -q "^UU CHANGELOG.md"; then
              echo "CHANGELOG.md has conflicts, accepting version from main..."
              git checkout --ours CHANGELOG.md
              git add CHANGELOG.md
            fi
            
            # Auto-resolve package.json conflicts (accept incoming from main)
            if git status --porcelain | grep -q "^UU package.json"; then
              echo "package.json has conflicts, accepting version from main..."
              git checkout --ours package.json
              git add package.json
            fi
            
            # Auto-resolve backport.yml conflicts (accept incoming from main)
            if git status --porcelain | grep -q "^UU .github/workflows/backport.yml"; then
              echo "backport.yml has conflicts, accepting version from main..."
              git checkout --ours .github/workflows/backport.yml
              git add .github/workflows/backport.yml
            fi
            
            # Check for remaining unresolved conflicts
            CONFLICTS=$(git diff --name-only --diff-filter=U)
            if [ -n "$CONFLICTS" ]; then
              echo "Unable to auto-resolve conflicts in: $CONFLICTS"
              echo "Please resolve manually on branch: ${BACKPORT_BRANCH}"
              git cherry-pick --abort
              exit 1
            fi
            
            # Continue cherry-pick with auto-resolved conflicts
            git -c core.editor=true cherry-pick --continue
          fi

          git push origin ${BACKPORT_BRANCH}

      - name: Crear PR hacia develop
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          MERGE_SHA: ${{ github.event.pull_request.merge_commit_sha }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          BACKPORT_BRANCH=backport/pr-${PR_NUMBER}-to-develop
          
          PR_BODY="ðŸ”„ Backport automÃ¡tico de #${PR_NUMBER} a \`develop\`.

          **PR original:** #${PR_NUMBER}
          **TÃ­tulo:** ${PR_TITLE}
          **Commit:** ${MERGE_SHA}
          
          ---
          _Este PR fue creado automÃ¡ticamente por el workflow de backport._"
          
          # Create PR, with or without label depending on if it exists
          if gh label list | grep -q "^backport"; then
            gh pr create \
              --base develop \
              --head ${BACKPORT_BRANCH} \
              --title "Backport #${PR_NUMBER} to develop" \
              --body "${PR_BODY}" \
              --label backport
          else
            echo "Warning: 'backport' label not found, creating PR without label"
            gh pr create \
              --base develop \
              --head ${BACKPORT_BRANCH} \
              --title "Backport #${PR_NUMBER} to develop" \
              --body "${PR_BODY}"
          fi
